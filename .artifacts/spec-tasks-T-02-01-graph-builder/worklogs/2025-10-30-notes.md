# Development Notes - 2025-10-30

**Task**: T-02-01-graph-builder - Graph Builder - AST Parsing & Construction
**Date**: 2025-10-30 (Day 6 - Final Completion Day)
**Author**: Rust Dev 1 + Claude Code Agent

---

## Technical Notes

### Architecture Overview (Current State)

**Module Structure** (14 modules, 5,214 lines):
```
crates/cds-index/src/graph/
‚îú‚îÄ‚îÄ mod.rs (17 public functions, API surface)
‚îú‚îÄ‚îÄ parser.rs (426 lines - tree-sitter integration)
‚îú‚îÄ‚îÄ traversal.rs (64 lines - graph traversal helpers)
‚îî‚îÄ‚îÄ builder/
    ‚îú‚îÄ‚îÄ mod.rs (main orchestration)
    ‚îú‚îÄ‚îÄ state.rs (458 lines - BuilderState)
    ‚îú‚îÄ‚îÄ imports.rs (674 lines - 21 functions, import resolution)
    ‚îú‚îÄ‚îÄ behaviors.rs (195 lines - invoke/inherit edges)
    ‚îú‚îÄ‚îÄ aliases.rs (alias map helpers)
    ‚îú‚îÄ‚îÄ language.rs (language detection)
    ‚îî‚îÄ‚îÄ python/
        ‚îú‚îÄ‚îÄ mod.rs (AST walker)
        ‚îú‚îÄ‚îÄ ast_utils.rs (645 lines - AST queries, TYPE_CHECKING)
        ‚îú‚îÄ‚îÄ import_resolver.rs (import directive parsing)
        ‚îî‚îÄ‚îÄ call_extractor.rs (invoke edge extraction)
```

### Implementation Status

#### ‚úÖ Complete Components
1. **AST Parser** (`parser.rs`)
   - Tree-sitter Python grammar integration
   - Query pattern loading from LocAgent `.scm` files
   - Handles all Python syntax elements

2. **Graph Data Model** (`mod.rs`)
   ```rust
   pub enum NodeKind {
       Directory, File, Class, Function  // All 4 ‚úÖ
   }

   pub enum EdgeKind {
       Contain, Import, Invoke, Inherit  // All 4 ‚úÖ
   }
   ```

3. **Import Resolution** (`imports.rs`)
   - 21 functions handling all import patterns
   - `ModuleExports` tracking system
   - Wildcard import expansion
   - Re-export chain resolution
   - TYPE_CHECKING block support (Day 5)

4. **Invoke/Inherit Edges** (`behaviors.rs`)
   - AST-based call expression extraction
   - Decorator analysis
   - Class inheritance detection
   - Multi-target alias resolution (Day 4)

5. **Parity Validation** - üü¢ EXCELLENT
   - 6/6 fixtures within ‚â§2% tolerance
   - 0% variance on nodes/contains/inherits/imports for best fixtures
   - Invokes within +0.09% to +1.29% range

#### ‚ö†Ô∏è Incomplete Components
1. **Test Coverage** (~30%, need >80%)
   - 8 unit tests (7 pass, 1 fail)
   - Missing: nested classes, async, error handling, etc.

2. **API Documentation**
   - Public functions lack doc comments
   - No usage examples in docs

---

## Research & Learning

### Findings from Day 1-5 Implementation

#### Key Insight 1: LocAgent's Export Tracking is Critical
**Question**: Why were import edges initially +23.85% off parity?

**Answer**: LocAgent uses comprehensive `ModuleExports` tracking to resolve `from pkg import Symbol` across re-export chains. Without mirroring this system, we missed edges.

**Solution**: Implemented complete `ModuleExports` model in Day 3:
- Parse `__all__` declarations
- Track re-exports in `__init__.py`
- Defer attribute resolution until after directory pass
- Result: Import parity RESOLVED (0% variance)

**References**:
- `tmp/LocAgent/dependency_graph/build_graph.py` lines 1420-1580
- `crates/cds-index/src/graph/builder/imports.rs` lines 200-350

#### Key Insight 2: TYPE_CHECKING Blocks Require Special Handling
**Question**: Why did pytest fixture have missing `inherits` edges?

**Answer**: LocAgent's `find_in_block()` descends into `if TYPE_CHECKING:` blocks to discover decorator base classes. Our initial implementation skipped these blocks.

**Solution** (Day 5):
- Extended `find_in_block()` to recursively check if-statement bodies
- Specifically target `if TYPE_CHECKING:` patterns
- Result: pytest inherits restored to 0% variance

**Code Change**:
```rust
// crates/cds-index/src/graph/builder/python/ast_utils.rs
pub fn find_in_block(node: Node, target: &str) -> bool {
    // ... existing logic ...
    if node.kind() == "if_statement" {
        for child in node.children(&mut node.walk()) {
            if child.kind() == "block" && find_in_block(child, target) {
                return true;  // Descend into TYPE_CHECKING blocks
            }
        }
    }
    // ...
}
```

**Impact**: Restored 13 inherits edges in pytest (mark decorators using pytest.Mark base class)

#### Key Insight 3: Grouped Imports Need Alias-Labeled Edges
**Question**: Why did Django fixture have import variance after parity was initially resolved?

**Answer**: LocAgent emits file-level edges with alias labels for grouped imports like `from foo import a, b, c`. Our fallback logic only emitted plain file edges.

**Solution** (Day 5):
```rust
// When we can't resolve individual symbols in grouped import
for alias_name in ["a", "b", "c"] {
    emit_edge(Edge {
        kind: Import,
        source: current_file,
        target: imported_file,
        label: Some(alias_name),  // Key: preserve alias
    });
}
```

**Result**: Django imports restored to 0% variance (463/463 edges)

---

## Testing Strategy

### Current Test Suite

#### Unit Tests (8 tests)
1. ‚úÖ `import_edges_capture_aliases` - Basic import with alias
2. ‚ùå `import_edges_follow_package_reexports` - **FAILING** (re-export chain)
3. ‚úÖ `wildcard_imports_expand_all_exports` - `from foo import *`
4. ‚úÖ `exports_follow_module_all_aliases` - `__all__` tracking
5. ‚úÖ `behavior_edges_detect_invokes_and_inherits` - Calls + inheritance
6. ‚úÖ `invoke_edges_follow_import_aliases` - Alias resolution
7. ‚úÖ `decorator_aliases_emit_invoke_edges` - Decorator edges
8. ‚úÖ `invoke_edges_include_all_alias_candidates` - Multi-target (Day 4)

#### Integration Tests (1 test)
- ‚úÖ `graph_parity_baselines` - Validates all 6 fixtures against golden outputs

### Planned Test Expansion (Session 1-2)

**Priority 1 - Core Language Features** (Must Add):
```rust
#[test]
fn nested_classes_detected() {
    // Outer::Inner::Deep structure
}

#[test]
fn nested_functions_detected() {
    // closure scenarios
}

#[test]
fn async_functions_parsed() {
    // async def + await
}

#[test]
fn lambdas_create_function_nodes() {
    // lambda x: x + 1
}
```

**Priority 2 - Import Edge Cases**:
```rust
#[test]
fn relative_imports_resolve() {
    // from . import foo
    // from .. import bar
}

#[test]
fn circular_imports_handled() {
    // a.py imports b.py, b.py imports a.py
}
```

**Priority 3 - Error Handling**:
```rust
#[test]
fn invalid_syntax_returns_error() {
    // Malformed Python should error gracefully
}

#[test]
fn empty_files_produce_file_node_only() {
    // Empty .py file ‚Üí 1 file node, no classes/functions
}
```

**Priority 4 - Inheritance**:
```rust
#[test]
fn single_inheritance_creates_inherit_edge() {
    // class Child(Parent)
}

#[test]
fn multiple_inheritance_creates_multiple_edges() {
    // class Child(A, B, C)
}
```

### Test Coverage Goal
- **Current**: 8 tests ‚âà 30% coverage
- **Target**: 23-28 tests ‚âà 85% coverage
- **Strategy**: Add 15-20 focused tests covering spec edge cases

---

## Performance Observations

### Parity Harness Timing (Latest Run)
- **Total Time**: <60 seconds for 6 repos
- **Largest Repo**: django (6,876 nodes, 10,002 edges)
- **Fastest**: matplotlib (1,304 nodes, <5s)

**Conclusion**: Performance well within acceptable range for MVP. No optimization needed.

### Memory Usage
- Not profiled yet (defer to performance benchmark task T-08-04)
- Expectation: <500MB for LocAgent-sized repos (~150 files)

---

## Code Quality Checklist

### Pre-PR Checklist (To Complete Today)
- [ ] All tests pass (23+ tests, 100% pass rate)
- [ ] Clippy clean (0 warnings)
- [ ] Compilation clean (0 errors)
- [ ] Test coverage >80%
- [ ] Doc comments on public API
- [ ] No debug prints or commented code
- [ ] Git history clean (meaningful commits)

### Self-Review Notes
- ‚úÖ Code follows Rust idioms
- ‚úÖ Error handling comprehensive
- ‚úÖ Modular architecture (14 well-separated modules)
- ‚ö†Ô∏è Missing doc comments (to add in Session 2)
- ‚ö†Ô∏è Test coverage gap (to fill in Session 1-2)

---

## Integration Notes

### Downstream Dependencies (Blocked on T-02-01)

Once T-02-01 merges:
1. **T-02-02-sparse-index** (Rust Dev 2) ‚úÖ Can start immediately
   - Will consume `CodeGraph` output
   - Build BM25 + name index on top

2. **T-02-03-service-layer** (Rust Dev 1)
   - Requires both T-02-01 + T-02-02
   - JSON-RPC server exposing graph + search

3. **T-03-01-cli-commands** (Rust Dev 2)
   - CLI tools wrapping service endpoints

### API Surface for Index Builder

`CodeGraph` provides:
```rust
pub struct CodeGraph {
    nodes: HashMap<GraphNodeIndex, Node>,
    edges: Vec<Edge>,
}

impl CodeGraph {
    pub fn nodes(&self) -> impl Iterator<Item = &Node>;
    pub fn edges(&self) -> impl Iterator<Item = &Edge>;
    pub fn find_node_by_fqn(&self, fqn: &str) -> Option<&Node>;
}
```

**Usage in T-02-02**:
```rust
let graph = build_repo_graph(repo_path)?;
for node in graph.nodes() {
    if node.kind == NodeKind::Function {
        // Index function name + docstring for BM25
        index.add_document(node.id, node.name, node.docstring);
    }
}
```

---

## Risks & Mitigation

### Risk 1: Test Coverage Takes Too Long
**Probability**: Medium
**Impact**: High (blocks PR merge)
**Mitigation**:
- Prioritize highest-value tests first
- Accept 75% coverage if time constrained (document remaining in TODO)
- Can add more tests in follow-up PR

### Risk 2: Failing Test Reveals Systemic Bug
**Probability**: Low
**Impact**: High
**Mitigation**:
- We've already fixed similar issues in Day 3-5
- Worst case: Rollback Day 5 changes to `process_from_import()`
- Or: Skip test with `#[ignore]` and file follow-up issue

### Risk 3: Clippy Finds Breaking Issues
**Probability**: Low
**Impact**: Medium
**Mitigation**:
- Code already compiles cleanly
- Can use `#[allow(...)]` for non-critical lints
- Most issues likely cosmetic (e.g., `clippy::too_many_arguments`)

---

## TODO / Follow-up

### Today's Session Tasks
- [ ] Fix `import_edges_follow_package_reexports` (Session 1)
- [ ] Add 15-20 unit tests (Session 1-2)
- [ ] Run clippy (Session 2)
- [ ] Add doc comments (Session 2)
- [ ] Update metadata.yaml (Session 3)
- [ ] Create PR (Session 4)

### Future Improvements (Post-0.1.0)
- [ ] Add TypeScript/JavaScript support (v0.2.0 - Issue 10.03)
- [ ] Add Go support (v0.3.0 - Issue 10.05)
- [ ] Optimize graph construction for large repos (v0.4.0)
- [ ] Add incremental update support (v0.5.0)

---

## References

### Specifications
- **PRD**: `spacs/prd/0.1.0-MVP-PRDs-v0/02-cds-index-service.md` ¬ß2.1 (Graph Builder)
- **PRD**: `spacs/prd/0.1.0-MVP-PRDs-v0/06-rust-refactoring-plan.md` ¬ß4.2 (Parity)
- **Issue**: `spacs/issues/04-0.1.0-mvp/02-index-core/01-graph-build.md`
- **Task**: `spacs/tasks/0.1.0-mvp/02-index-core/T-02-01-graph-builder.md`

### Reference Implementation
- **LocAgent**: `tmp/LocAgent/dependency_graph/build_graph.py`
- **Query Patterns**: `tmp/LocAgent/dependency_graph/queries/`
- **Parity Methodology**: `docs/parity-validation-methodology.md`

### Related Tasks
- **T-06-01**: LocAgent Parity Methodology (‚úÖ Complete, provides baselines)
- **T-02-02**: Sparse Index (‚è∏ Blocked, waiting for T-02-01)
- **T-02-03**: Service Layer (‚è∏ Blocked, waiting for T-02-01 + T-02-02)

---

**Session Duration**: (To be updated)
**Productivity**: (To be assessed at EOD)
**Blockers**: None (all dependencies met)
**Overall Status**: 95% complete, final push underway
