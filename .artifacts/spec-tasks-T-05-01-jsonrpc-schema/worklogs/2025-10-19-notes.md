# Development Notes - 2025-10-19

**Task**: T-05-01-jsonrpc-schema
**Date**: 2025-10-19

---

## Technical Notes

### Schema Implementation

- **Snippet Field Optionality**: Changed from requiring all three fields (fold, preview, full) to only requiring fold
  - Rationale: snippet_mode parameter controls which fields are present
  - Prevents server from fabricating data to satisfy schema
  - Aligns with PRD specification for varying detail levels

- **Schema Validation Architecture**: Chose jsonschema crate with include_str! embedding
  - Embedded docs/api/jsonrpc-schema.json at compile time for reliability
  - Created inline entity schema to avoid $ref resolution issues
  - Works regardless of working directory

- **JSON Schema $ref Challenges**: jsonschema crate couldn't resolve internal $ref to #/definitions/entityType
  - Solution: Inline entity schema with all definitions expanded
  - Trade-off: Some duplication but more reliable for testing

### Test Coverage Evolution

**Initial (25 tests)**: Hand-crafted serde_json checks
**Review Feedback**: Tests didn't actually load/validate against embedded schema
**Final (29 tests)**: Added embedded_schema_validation_tests module
- test_search_entities_fixture_validates()
- test_traverse_graph_fixture_validates()
- test_error_response_fixture_validates()
- test_schema_drift_detection()

### Documentation Corrections

- Fixed timestamps: 2025-10-20 → 2025-10-19 (actual task start date)
- Fixed relative path: ../../../tests/fixtures/api → ../../tests/fixtures/api
- All documentation now aligns with 2025-10-19 as the implementation date

## Research & Learning

- Reviewed PRD-05 §2-4 for snippet field requirements
- Studied jsonschema 0.18 API for Draft 7 validation
- Evaluated include_str! vs runtime file loading for test reliability
- Explored $ref resolution limitations in jsonschema crate

## Challenges & Solutions

### Challenge 1: Snippet Schema Contradiction
**Problem**: Schema required all fields even when snippet_mode='fold'
**Solution**: Made only fold required, preview/full optional
**Lesson**: Schema must reflect actual API behavior, not ideal behavior

### Challenge 2: Schema Validation Not Actually Running
**Problem**: Tests existed but didn't validate against embedded schema
**Solution**: Added embedded_schema_validation_tests module with actual validation
**Lesson**: Test what you claim to test

### Challenge 3: File Path Resolution
**Problem**: Relative paths failed at runtime
**Solution**: Use include_str! for compile-time embedding
**Lesson**: Compile-time guarantees beat runtime assumptions

## TODO / Follow-up

- [x] Relax snippet.required fields based on snippet_mode
- [x] Wire jsonschema validation into service_contract_tests.rs
- [x] Fix docs/api/README.md relative link to fixtures
- [x] Refresh last-updated timestamps across docs/api/*.md
- [x] Update task status to Completed
- [ ] Integrate schema validation into CLI integration tests (future work)
- [ ] Consider schemars for type-driven schema generation (future work)

---

**Session Duration**: 5.5 hours total (2.0h initial + 1.5h review fixes + 2.0h final fixes)
**Blockers**: None - all acceptance criteria met
