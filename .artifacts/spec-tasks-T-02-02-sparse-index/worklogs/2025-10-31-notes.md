# Development Notes - 2025-10-31

**Task**: T-02-02-sparse-index
**Date**: 2025-10-31

---

## Technical Notes

### Architecture Decisions

- **Decision 1**: Hierarchical two-tier index design
  - Upper tier: Name/ID HashMap for exact and prefix matching
  - Lower tier: BM25 full-text search for content-based retrieval
  - Rationale: Balances speed (HashMap O(1)) with recall (BM25 semantic ranking)

- **Decision 2**: Defer BM25 library choice until Phase 3
  - Options: Tantivy (full-featured) vs custom implementation
  - Need to evaluate: LocAgent parity requirements, memory footprint, latency targets

### Implementation Details

#### Phase 1: Upper Index (Name/ID HashMap) - Days 1-2

Not yet implemented. Planned structure:

```rust
pub struct NameIndex {
    // Exact name → entity ID mapping
    exact_map: HashMap<String, EntityId>,

    // Prefix → entity IDs mapping (for autocomplete/fuzzy search)
    prefix_trie: HashMap<String, Vec<EntityId>>,

    // Reverse lookup: entity ID → metadata
    entities: HashMap<EntityId, EntityMetadata>,
}
```

Design considerations:

- Use fully-qualified names from T-02-01 graph builder
- Support both exact match and prefix queries
- Optimize for low memory overhead (target: <100MB for 10K entities)

#### Phase 2: Tokenizer - Day 3

Custom tokenizer to match LocAgent behavior:

- Word-level tokenization with camelCase/snake_case splitting
- Stop word removal? (TBD - check LocAgent implementation)
- Stemming? (TBD - check LocAgent implementation)

### Dependencies

- **Internal**: `crates/cds-index/src/graph` (T-02-01 completed)
  - Provides entity metadata: name, type, file path, AST range
  - Graph traversal for context expansion (e.g., class context for methods)

- **External**: TBD based on BM25 implementation choice
  - Option A: `tantivy = "0.22"` (full Lucene-like features)
  - Option B: Custom BM25 with `rust-tokenizers` or `unicode-segmentation`

## Research & Learning

### Questions Investigated

1. **Question**: What BM25 parameters does LocAgent use?
   - **Answer**: Need to check `tmp/LocAgent/plugins/location_tools/retriever/bm25_retriever.py`
   - **Key Insight**: LocAgent likely uses default k1=1.5, b=0.75 (standard Okapi BM25)
   - **References**: Will document in Phase 3 after examining LocAgent code

2. **Question**: How to achieve 90% search overlap@10 target?
   - **Answer**: Requires:
     1. Matching LocAgent tokenization (critical!)
     2. Same BM25 parameters (k1, b)
     3. Same document chunking strategy (if any)
   - **References**: T-06-01 parity baselines in `tests/fixtures/parity/golden_outputs/search_queries.jsonl`

### New Learnings

- T-02-01 graph builder provides solid foundation: 4 node types, 4 edge types, <2% parity variance
- 50 search queries from LocAgent available as baseline (T-06-01 Phase 2)
- Performance target: <500ms p95 latency, <5s index build for 1K files

## Code Review Notes

### Self-Review Checklist

- [ ] Code follows project style guide (rustfmt)
- [ ] Unit tests added (target: >95% coverage)
- [ ] Documentation updated (inline docs + README)
- [ ] No commented-out code
- [ ] Error handling implemented
- [ ] Performance considerations addressed (benchmarks in place)

### Future Refactoring Opportunities

- Consider trait-based index abstraction for pluggable backends
- Explore incremental index updates (vs full rebuild)

## Testing Notes

### Test Strategy

1. **Unit tests** (crates/cds-index/tests/index_tests.rs):
   - Name index: exact match, prefix match, case sensitivity
   - BM25: scoring correctness, parameter tuning
   - Tokenizer: edge cases (unicode, punctuation, camelCase)

2. **Parity tests** (crates/cds-index/tests/search_parity_tests.rs):
   - Use 50 search queries from T-06-01 baselines
   - Measure overlap@10 against LocAgent results
   - Target: ≥90% overlap

3. **Benchmark tests** (crates/cds-index/benches/search_bench.rs):
   - Latency: p50, p95, p99 for various query types
   - Throughput: queries per second
   - Index build time: varies by repo size

### Test Coverage

Not yet measured. Will use `cargo tarpaulin` after Phase 1 implementation.

## Performance Notes

### Target Metrics (from acceptance criteria)

- Search latency: <500ms p95
- Index build: <5s for 1K files
- Memory: TBD (reasonable upper bound needed)

### Optimization Ideas

- Lazy index loading (mmap for large indices)
- Query result caching (LRU cache for frequent queries)
- Parallel index construction (rayon for multi-core utilization)

## TODO / Follow-up

- [ ] Review LocAgent BM25 implementation (`tmp/LocAgent/plugins/location_tools/retriever/bm25_retriever.py`)
- [ ] Review LocAgent tokenizer (`tmp/LocAgent/repo_index/utils/tokenization.py`)
- [ ] Design Upper Index API (search by name, search by prefix)
- [ ] Set up benchmark framework (criterion.rs)
- [ ] Create test fixtures for index tests

## References

- **PRD**: spacs/prd/0.1.0-MVP-PRDs-v0/02-cds-index-service.md (Section 3.2: Index Architecture)
- **Issue**: spacs/issues/04-0.1.0-mvp/02-index-core/02-sparse-index.md
- **Task**: spacs/tasks/0.1.0-mvp/02-index-core/T-02-02-sparse-index.md
- **Parity baseline**: tests/fixtures/parity/golden_outputs/search_queries.jsonl (50 queries from T-06-01)
- **LocAgent reference**: tmp/LocAgent/plugins/location_tools/retriever/bm25_retriever.py

---

**Session Duration**: 0.2 hours (12 minutes - Day 1 Session 1)
**Productivity**: High (documentation updates completed)
**Blockers**: None
