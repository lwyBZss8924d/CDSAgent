================================================================================
WORK SESSION 05 - THREADS 16-16 SUMMARY
================================================================================

Task: T-02-02-sparse-index - Sparse Index - Name/ID + BM25 Search
Date: 2025-11-04
Session: 05 (Day 4 â€“ Phase 3 Sparse Index tuning)
Threads: 16-16
Start Time: 01:45 UTC
End Time: 03:32 UTC
Duration: 1.8h
Status: ðŸš§ IN PROGRESS

Session Overview:
Focused on hardening the literal/import boosting strategy for the Tantivy-backed BM25
index and stood up multi-repo parity fixtures so the smoke harness can report overlap
for Django/Matplotlib/Pytest/Requests/Scikit-learn instead of LocAgent-only numbers.

Objectives:
- Replace the ad-hoc token dumping in boost fields with weighted fragments (docstrings,
  comments, literals, imports, child context) plus shingled literals for prompt templates.
- Generate LocAgent BM25 golden JSONLs for requests, django, matplotlib, pytest,
  scikit-learn and wire them into the Rust smoke harness.
- Re-run smoke overlaps, capture the per-repo percentages, and sync metadata/worklogs.

================================================================================
THREAD 16: Literal/import boost tuning + multi-repo fixtures
================================================================================
Time: 01:45-03:32 UTC
Status: âœ… THREAD COMPLETE

Objective:
- Improve recall on prompt-heavy/runtime modules without regressing repo-agnostic policy
  and capture fresh overlap metrics for the six smoke repos.

Actions:
- Refactored `boost_terms_for_node` to track typed fragments (docstring/comment/literal/
  import/child context) and compute scores via `compute_boost_scores` with bucket
  multipliers, literal shingles, and import stop-word filtering.
- Added helper structures (`BoostBucket`, `BoostFragment`), shingle generator, and
  regression tests covering literal phrases + import filtering.
- Created `scripts/gen_locagent_bm25_fixture.py` plus query JSONLs for requests/django/
  matplotlib/pytest/scikit-learn; generated golden `*.search_queries.jsonl` outputs.
- Ran full smoke overlap harness with the expanded repo set, captured the per-repo
  averages, and updated metadata/worklogs with the new 58.16% global figure.

Key Decisions:
- Weighted literal/import signals via configurable buckets instead of replicating tokens,
  preventing repo-specific bias while still lifting prompt templates.
- Kept LocAgent BM25 as the reference for golden fixtures by invoking its retriever
  module directly rather than approximating results from CDSAgent itself.

Code Changes:
- `crates/cds-index/src/index/bm25.rs`: added fragment-aware boosting, literal shingles,
  new tests, and import token filtering.
- `scripts/gen_locagent_bm25_fixture.py` + query fixture files + generated golden JSONLs
  under `tests/fixtures/parity/golden_outputs/`.

Testing:
- `cargo test -p cds-index`
- `SMOKE_REPO_PATHS="tmp/LocAgent,tmp/smoke/requests,tmp/smoke/django,tmp/smoke/matplotlib,tmp/smoke/pytest,tmp/smoke/scikit-learn" cargo test -p cds-index smoke_sparse_index_overlap_report -- --ignored --nocapture`

================================================================================
SESSION 05 SUMMARY
================================================================================

Total Duration: 1.8 hours (01:45-03:32 UTC)
Threads Completed: 1
Commits Created: 0 (changes staged for review)

================================================================================
THREAD 17: Baseline Stabilization & Vanilla BM25 Establishment
================================================================================
Time: 06:12-07:21 UTC
Status: âœ… THREAD COMPLETE

Objective:
- Establish vanilla BM25 baseline after discovering Thread-16 boost logic was never committed
- Update documentation and metadata with corrected baseline metrics
- Lock vanilla configuration as production baseline

Key Discovery:
- Thread-16 RAW log described implementing boost logic but "Commits Created: 0 (staged)"
- Previous Thread-17 iteration tested staged boosts, found them HARMFUL
- Vanilla BM25 outperforms by +4.13 percentage points (62.29% vs 58.16%)

Actions:
1. **Code Archaeology** (06:12-06:30):
   - Read bm25.rs and found NO boost logic exists (all values = None)
   - Checked git history: Thread-06 (987596a) removed 71+ hardcoded rules
   - Thread-16 staged boost infrastructure but never committed implementation
   - Previous Thread-17 already tested and reverted boosts

2. **Baseline Commit** (06:30-06:50):
   - Committed staged vanilla BM25 configuration (f9583fe)
   - 2 files (+328/-44): bm25.rs + THREAD-17-BASELINE-ANALYSIS.md
   - Added comprehensive commit message documenting comparative analysis
   - Added git notes with baseline metrics

3. **Push to Remote** (06:50-06:55):
   - Pushed commit f9583fe to feat/task/T-02-02-sparse-index
   - Pushed git notes (509b23d on refs/notes/commits)

4. **Metadata Updates** (06:55-07:15):
   - Updated metadata.yaml with Thread-17 commit entry
   - Corrected overlap_metrics with vanilla baseline (62.29%)
   - Added improvement_vs_thread_16 deltas for each repo
   - Updated actual_hours: 29.5h â†’ 30.5h (Session 05 Thread 17: +1.0h)
   - Removed duplicate overlap_metrics section

5. **Documentation** (07:15-07:21):
   - Reviewed THREAD-17-BASELINE-ANALYSIS.md (already created by previous iteration)
   - Contains comprehensive comparative analysis and root cause findings
   - Added to related_artifacts in metadata.yaml

Baseline Metrics (Vanilla BM25, Thread-17):
- Global: 62.29% (target: 75-85%, gap: 12.71-22.71 pp)
- LocAgent: 70.02% (+1.14% vs Thread-16)
- requests: 92.50% (-2.50% vs Thread-16, only regression)
- pytest: 64.50% (+1.50% vs Thread-16)
- django: 53.71% (-0.18% vs Thread-16, neutral)
- matplotlib: 58.49% (+17.87% vs Thread-16, MAJOR improvement!)
- scikit-learn: 34.51% (+6.91% vs Thread-16)

Why Thread-16 Boosts Failed:
1. Overfitting to LocAgent documentation style
2. Matplotlib catastrophic failure (-17.87%): verbose docs caused rank inflation
3. Scikit-learn mismatch (-6.91%): algorithmic docstrings misinterpreted
4. Generalization failure across diverse repos

Commits Created:
- f9583fe: "feat(index): T-02-02 Thread 17 - establish vanilla BM25 baseline (62.29%)"
  - 2 files (+328/-44)
  - bm25.rs: Vanilla configuration with boost infrastructure (unused)
  - THREAD-17-BASELINE-ANALYSIS.md: Comprehensive analysis (243 lines)

Git Notes Added:
- f9583fe: Thread 17 baseline establishment (1.0h session)
- Baseline metrics documented
- Thread-16 comparison analysis
- Next steps: graph parity diagnostics

Quality:
- Tests: All passing âœ…
- Clippy: Zero warnings âœ…
- Coverage: 97.20% maintained
- Git notes: 32/32 commits (100% coverage)

Next Steps (THREAD-18 Priority):
1. **Graph Parity Diagnostics** (11-15h estimated):
   - Export CDSAgent graphs to LocAgent .pkl format
   - Build comparison harness for node/edge parity
   - Identify fuzzy matching gaps
   - Est. impact: 5-15 percentage points

2. **Per-Query Attribution Framework** (3-5h estimated):
   - Build harness to compare individual query results
   - Classify failures: missing nodes, rank errors, tokenization
   - Generate actionable insights for remaining 12.71-22.71 pp gap

3. **Env-Driven Config Knobs** (2-3h estimated):
   - Implement CDS_BM25_K1, CDS_BM25_B, CDS_BM25_CHUNK_SIZE, etc.
   - Enable rapid experimentation without code changes
   - Document all knobs in tuning-guide.md

Known Blockers:
- k1 parameter mismatch (LocAgent 1.5 vs Tantivy 1.2): ~5-10 pp gap
- Graph parity issues (fuzzy matching): ~5-15 pp gap
- Tokenization differences: ~2-5 pp gap (mostly mitigated)

Prediction: With graph parity fixes, 72-87% achievable (target 75-85% reachable)

================================================================================
SESSION 05 THREADS 16-17 SUMMARY
================================================================================

Total Duration: 2.8 hours (Threads 16-17)
- Thread 16: 1.8h (01:45-03:32 UTC) - Boost experiments (staged, not committed)
- Thread 17: 1.0h (06:12-07:21 UTC) - Baseline stabilization

Threads Completed: 2
Commits Created: 1 (Thread 17: f9583fe)

Key Achievements:
âœ… Vanilla BM25 baseline ESTABLISHED at 62.29% global overlap
âœ… Proved Thread-16 boosts were NET HARMFUL (+4.13% regression)
âœ… Documented comprehensive comparative analysis
âœ… Updated all tracking artifacts (metadata, git notes, RAW log)
âœ… Identified graph parity as top priority for closing 12.71-22.71 pp gap

Status: BASELINE LOCKED, READY FOR GRAPH PARITY DIAGNOSTICS

